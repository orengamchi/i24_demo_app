<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×××©×§ ×œ×•×‘×™ | ××¢×¨×›×ª ×’×¨×¤×™×§×” i24NEWS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;700&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --bg-dark: #0f172a;
            --primary-blue: #3b82f6;
            --text-light: #f1f5f9;
            --card-bg: #1e293b;
            --card-hover: #334155;
            --border-color: #475569;
            --header-strip-height: 50px;
        }
        body {
            font-family: 'Heebo', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            padding-top: var(--header-strip-height);
        }

        /* --- ×‘×× ×¨ --- */
        .video-banner-container { position: relative; height: 300px; overflow: hidden; background-color: #0d1222; }
        #dynamic-banner-container { margin-top: calc(-1 * var(--header-strip-height)); }
        .video-banner { position: absolute; top: 50%; left: 50%; min-width: 100%; min-height: 100%; transform: translate(-50%, -50%); object-fit: cover; z-index: 0; }
        .video-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.4); z-index: 1; }
        .video-content { position: relative; z-index: 2; }

        /* --- ×›×¨×˜×™×¡×™× --- */
        .card-image-wrapper { height: 200px; position: relative; overflow: hidden; background: #0f172a; }
        .card-image-wrapper::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 60%; background: linear-gradient(to top, rgba(255, 255, 255, 0.15) 0%, rgba(150, 150, 150, 0.05) 50%, rgba(255, 255, 255, 0) 100%); z-index: 3; pointer-events: none; }
        .card-image-wrapper::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(to bottom, rgba(15, 23, 42, 0) 0%, rgba(15, 23, 42, 0.8) 100%); z-index: 1; }
        .template-image-wrapper { height: 140px; position: relative; overflow: hidden; display: flex; justify-content: center; align-items: center; background: #0f172a; transition: background 0.3s; }
        .card-image { width: 100%; height: 100%; background-size: cover; background-position: center top; transition: transform 0.5s ease; opacity: 0.9; position: relative; z-index: 2; }
        .presenter-card:hover .card-image { transform: scale(1.05); opacity: 1; }
        .geo-icon { font-size: 2.5rem; color: rgba(255,255,255,0.85); transition: transform 0.3s, color 0.3s; }
        .template-card:hover .geo-icon { transform: scale(1.1) rotate(5deg); color: #fff; }
        .disabled-card { opacity: 0.6; cursor: not-allowed !important; }
        .disabled-card:hover { transform: none !important; box-shadow: none !important; }

        /* --- ×¡×¨×’×œ ×¢×œ×™×•×Ÿ --- */
        #shortcut-strip { position: fixed; top: 0; right: 0; left: 0; height: var(--header-strip-height); background-color: #0f172a; z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.5); display: flex; align-items: center; padding-right: 1rem; border-bottom: 1px solid #334155; }
        .dropdown-menu { display: none; position: absolute; top: 100%; right: 0; width: 250px; background-color: #1e293b; border: 1px solid #475569; border-radius: 0 0 8px 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); flex-direction: column; z-index: 1001; max-height: 80vh; overflow-y: auto; }
        .dropdown-menu.show { display: flex; }
        .dropdown-item { padding: 12px 16px; text-align: right; color: #e2e8f0; border-bottom: 1px solid #334155; transition: all 0.2s; cursor: pointer; border-right: 4px solid transparent; }
        .dropdown-item:hover { background-color: #334155; }
        .menu-btn { display: flex; align-items: center; gap: 8px; color: white; font-weight: bold; cursor: pointer; padding: 8px 12px; border-radius: 6px; transition: background 0.2s; }
        .menu-btn:hover { background-color: #334155; }

        /* --- ×˜×•×¤×¡ --- */
        .order-form { background-color: var(--card-bg); box-shadow: 0 4px 10px rgba(0, 0, 0, 0.6); border-top-width: 4px; }
        .input-style, .select-style { width: 100%; padding: 10px; border-radius: 6px; background-color: #334155; border: 1px solid var(--border-color); color: white; transition: border-color 0.2s, box-shadow 0.2s; }
        .input-style:focus, .select-style:focus { outline: none; border-color: var(--primary-blue); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.3); }
        .readonly-info { background-color: #0f172a !important; cursor: default; }
        .section-input-style { max-width: 90%; margin: 0 auto; display: block; }
        .cancelled input[type="text"], .cancelled .input-style { background-color: #451a1a !important; border-color: #ef4444 !important; text-decoration: line-through; color: #fca5a5; }
        .hidden { display: none !important; }
        .hidden-bullet-row { display: none; } 
        input[type="date"]::-webkit-calendar-picker-indicator, input[type="time"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }

        /* --- Drag & Drop Zone --- */
        .dropzone { border: 2px dashed #475569; border-radius: 8px; padding: 20px; text-align: center; color: #94a3b8; transition: all 0.3s ease; cursor: pointer; background-color: #1e293b; position: relative; }
        .dropzone:hover, .dropzone.dragover { border-color: #3b82f6; background-color: #334155; color: white; }
        .dropzone-preview { max-height: 100px; margin: 10px auto; border-radius: 4px; display: none; }
    </style>
</head>
<body class="min-h-screen">

    <nav id="shortcut-strip">
        <div class="relative">
            <button onclick="toggleMenu(event)" class="menu-btn">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
                <span>×‘×—×™×¨×ª ××”×“×•×¨×”</span>
            </button>
            <div id="main-dropdown" class="dropdown-menu"></div>
        </div>
    </nav>

    <div id="dynamic-banner-container" class="video-banner-container">
        <video id="banner-video" autoplay muted loop class="video-banner">
            <source id="banner-video-source" src="" type="video/mp4">
        </video>
        <div class="video-overlay"></div>
        <div class="video-content flex flex-col justify-center items-center h-full text-center p-4">
            <div id="banner-titles" class="mt-4">
                <h2 id="banner-title" class="text-3xl font-bold text-white"></h2>
                <p id="banner-subtitle" class="text-lg text-gray-300"></p>
            </div>
        </div>
    </div>

    <main class="max-w-7xl mx-auto p-4 md:p-8 relative z-10">
        <div id="lobby-view" class="mt-6">
            <div id="presenters-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></div>
        </div>

        <div id="template-lobby-view" class="hidden">
            <button onclick="showLobby()" class="flex items-center text-gray-400 hover:text-blue-400 mb-6 font-bold transition group">
                <span class="text-xl ml-2 transform group-hover:translate-x-1 transition-transform">&#8594;</span> ×—×–×•×¨ ×œ×‘×—×™×¨×ª ××”×“×•×¨×”
            </button>
            <div id="templates-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6"></div>
        </div>

        <div id="bullets-form-view" class="hidden">
            <button onclick="showTemplateLobby()" class="flex items-center text-gray-400 hover:text-blue-400 mb-6 font-bold transition group">
                <span class="text-xl ml-2 transform group-hover:translate-x-1 transition-transform">&#8594;</span> ×—×–×•×¨ ×œ×‘×—×™×¨×ª ×ª×‘× ×™×ª
            </button>
            
            <div class="max-w-3xl mx-auto p-6 rounded-xl order-form" id="form-card">
                <header class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                    <h2 class="text-2xl font-bold text-white" id="main-form-title">ğŸ“ ×˜×•×¤×¡ ×”×–×× ×”</h2>
                </header>

                <p id="live-datetime" class="text-gray-400 text-sm mb-6 text-center" dir="ltr"></p>
                
                <form id="orderForm" class="space-y-6">
                    <!-- ×¤×¨×˜×™ ×”×–×× ×” -->
                    <div class="p-4 border border-gray-600 rounded-lg" id="details-section">
                        <h3 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2 text-blue-400 form-section-title">×¤×¨×˜×™ ×”×–×× ×”</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×©× ×”×©×•×œ×—:</label>
                                <input type="text" id="sender-name" class="input-style" placeholder="[×”×§×œ×“ ×›××Ÿ]">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×©× ×”××”×“×•×¨×”:</label>
                                <input type="text" id="edition-name" class="input-style" placeholder="[×”×§×œ×“ ×›××Ÿ]">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×ª××¨×™×š ×©×™×“×•×¨:</label>
                                <input type="date" id="broadcast-date" class="input-style">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×©×¢×” ××©×•×¢×¨×ª:</label>
                                <input type="time" id="estimated-time" class="input-style">
                            </div>
                        </div>
                    </div>

                    <!-- ××¤×¨×˜ ×˜×›× ×™ -->
                    <div class="p-4 border border-gray-600 rounded-lg" id="tech-specs-section">
                        <h3 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2 text-blue-400 form-section-title">××¤×¨×˜ ×˜×›× ×™</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                            <div class="flex items-center space-x-2 space-x-reverse mb-3">
                                <input type="checkbox" id="glass-wall-mode" class="h-5 w-5 text-blue-500 rounded border-gray-300 focus:ring-blue-500">
                                <label for="glass-wall-mode" class="text-sm text-gray-300 mr-2">××¦×‘ ×§×™×¨ ×–×›×•×›×™×ª</label>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×’×•×“×œ ×¤×•× ×˜ ×›×•×ª×¨×ª:</label>
                                <input type="number" id="title-font-size" class="input-style" value="135">
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×¦×•×¨×ª ×‘×•×œ×˜×™×:</label>
                                <select id="bullet-shape" class="select-style">
                                    <option value="none">××¡×¤×¨×™× (×‘×¨×™×¨×ª ××—×“×œ)</option>
                                    <option value="square">×¨×™×‘×•×¢</option>
                                    <option value="circle">×¢×™×’×•×œ</option>
                                    <option value="hidden">×œ×œ×</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×× ×™××¦×™×™×ª ×‘×•×œ×˜×™×:</label>
                                <select id="bullet-animation" class="select-style">
                                    <option value="slide">Slide</option>
                                    <option value="scale">Scale</option>
                                    <option value="fade">Fade</option>
                                </select>
                            </div>
                            
                            <!-- ×©×“×” ×–××Ÿ ×§×•××¤×•×–×™×¦×™×” × ×©××¨ ×‘×××©×§ ×œ×¦×•×¨×š ×ª×¦×•×’×” ××§×“×™××” ××š ×œ× ×‘×™×™×¦×•× -->
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×–××Ÿ ×§×•××¤×•×–×™×¦×™×” (×ª×¦×•×’×” ×‘×œ×‘×“):</label>
                                <select id="composition-duration" class="select-style">
                                    <option value="30">30 ×©× ×™×•×ª</option>
                                    <option value="45">45 ×©× ×™×•×ª</option>
                                    <option value="90">90 ×©× ×™×•×ª</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ×§×‘×¦×™× ××¦×•×¨×¤×™× -->
                    <div class="p-4 border border-gray-600 rounded-lg" id="attachments-section">
                        <h3 class="text-lg font-bold mb-4 border-b border-gray-600 pb-2 text-blue-400 form-section-title">×§×‘×¦×™× ××¦×•×¨×¤×™×</h3>
                        <div class="flex flex-wrap justify-between gap-4 mb-4">
                            <label class="flex items-center space-x-2 space-x-reverse cursor-pointer">
                                <input type="checkbox" class="attachment-checkbox form-checkbox h-5 w-5 text-blue-500 rounded" data-label="×§×•×‘×¥ ××•×“×™×•">
                                <span class="text-gray-300">×§×•×‘×¥ ××•×“×™×• (×§×¨×™×™× ×•×ª ×œ×’×¨×¤×™×§×”)</span>
                            </label>
                            <label class="flex items-center space-x-2 space-x-reverse cursor-pointer">
                                <input type="checkbox" class="attachment-checkbox form-checkbox h-5 w-5 text-blue-500 rounded" data-label="×ª××•× ×”">
                                <span class="text-gray-300">×ª××•× ×” (×¨×§×¢ ××• ××™×œ×•×¡×˜×¨×¦×™×”)</span>
                            </label>
                            <label class="flex items-center space-x-2 space-x-reverse cursor-pointer">
                                <input type="checkbox" class="attachment-checkbox form-checkbox h-5 w-5 text-blue-500 rounded" data-label="×§×•×‘×¥ ×•×™×“××•">
                                <span class="text-gray-300">×§×•×‘×¥ ×•×™×“××•</span>
                            </label>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×ª××•× ×” ×¨××©×™×ª:</label>
                                <div id="main-image-dropzone" class="dropzone">
                                    <p class="mb-2">×’×¨×•×¨ ×ª××•× ×” ×œ×›××Ÿ ××• ×œ×—×¥ ×œ×‘×—×™×¨×”</p>
                                    <input type="file" id="main-image-input" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                                    <img id="main-image-preview" class="dropzone-preview" alt="×ª×¦×•×’×” ××§×“×™××”">
                                    <input type="text" id="main-image-path" class="input-style mt-2 text-xs" placeholder="× ×ª×™×‘ ×”×§×•×‘×¥..." readonly>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm text-gray-400 mb-1">×§×™×©×•×¨ ×ª××•× ×ª ×¨×§×¢:</label>
                                <input type="text" id="bg-image-link" class="input-style" placeholder="[×”×“×‘×§ ×§×™×©×•×¨ ×›××Ÿ]">
                            </div>
                        </div>
                    </div>

                    <!-- ×ª×•×›×Ÿ ×“×™× ××™ -->
                    <div id="dynamic-content-section" class="p-4 border border-border-color rounded-lg"></div>

                    <!-- ×”×¢×¨×•×ª -->
                    <div class="p-4 rounded-lg">
                        <h3 class="text-lg font-bold text-gray-400 mb-2 form-section-title">×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×œ×’×¨×¤×™×§××™</h3>
                        <textarea id="notes" class="input-style h-24 resize-none" placeholder="[×”×§×œ×“ ×›××Ÿ]"></textarea>
                    </div>

                    <!-- ×“×™×¡×§×œ×™×™××¨ -->
                    <div class="p-4 border-t border-gray-700 mt-4">
                        <label class="block text-xs text-gray-500 mb-1 text-center font-bold">×˜×§×¡×˜ ×“×™×¡×§×œ×™×™××¨ (× ×™×ª×Ÿ ×œ×¢×¨×™×›×”):</label>
                        <textarea id="disclaimer-text" class="w-full bg-transparent text-xs text-gray-400 text-center border-none focus:ring-0 resize-none overflow-hidden" rows="2">* ×”×˜×•×¤×¡ ××™×•×¢×“ ×œ×©×™××•×© ×¤× ×™××™ ×‘×œ×‘×“. ×× × ×•×“××• ×›×™ ×›×œ ×”×¤×¨×˜×™× × ×›×•× ×™× ×œ×¤× ×™ ×”×©×œ×™×—×”.</textarea>
                    </div>

                    <!-- ×›×¤×ª×•×¨×™ ×¤×¢×•×œ×” ×ª×—×ª×•× ×™× -->
                    <div class="flex flex-col gap-3 mt-4 pt-4 border-t border-gray-700">
                        <button type="button" onclick="openEditorWithParams()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-500 hover:to-indigo-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all transform hover:scale-[1.01] flex justify-center items-center gap-2">
                            <i class="fa-solid fa-eye"></i>
                            ×œ×—×¥ ×œ×ª×¦×•×’×”
                        </button>
                        <button type="button" onclick="saveFormAsText()" class="w-full bg-green-600 hover:bg-green-500 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition-all flex justify-center items-center gap-2">
                            <i class="fa-solid fa-floppy-disk"></i>
                            ×©××•×¨ ×›×§×•×‘×¥ ×˜×§×¡×˜
                        </button>
                    </div>
                </form>
                
                <footer class="mt-8 text-center text-xs text-gray-500 border-t border-gray-700 pt-4">
                    &copy; OREN GAMCHI
                </footer>
            </div>
        </div>
    </main>

    <script>
        const DEFAULT_VIDEO = "https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/start%20here.mp4";
        const TEMPLATE_VIDEO = "https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/were%20here.mp4";
        
        const SHOWS = [
            { name: '×”××”×“×•×¨×” ×”××¨×›×–×™×ª', presenter: '××™×¨×™ ××™×›××œ×™ ×•×“× ×™××œ ×¨×•×˜-××‘× ×¨×™', role: '20:00', color: '#ef4444', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%9E%D7%99%D7%A8%D7%99_%D7%9E%D7%99%D7%9B%D7%90%D7%9C%D7%99_%D7%92%D7%93%D7%95%D7%9C.png', id: 'main' },
            { name: '×§×‘×™× ×˜ ×©×™×©×™', presenter: '× ×•×” ×“×¨×•××™', role: '×©×™×©×™ 19:53', color: '#f97316', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%A0%D7%95%D7%95%D7%94_%D7%93%D7%A8%D7%95%D7%9E%D7%99_%D7%92%D7%93%D7%95%D7%9C.png', id: 'fri' },
            { name: '××’×–×™×Ÿ ×”×©×‘×ª', presenter: '××™×›×œ ×¨×‘×™× ×•×‘×™×¥×³', role: '×©×‘×ª 19:50', color: '#22c55e', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%9E%D7%99%D7%9B%D7%9C_%D7%A8%D7%91%D7%99%D7%A0%D7%95%D7%91%D7%99%D7%A5_THUMB.png', id: 'sat' },
            { name: '×”××”×“×•×¨×” ×”××•×§×“××ª', presenter: '×©×¨×•×Ÿ ×’×œ', role: '19:00', color: '#eab308', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%A9%D7%A8%D7%95%D7%9F_%D7%92%D7%9C_THUMB.png', id: 'early' },
            { name: '××“×“ ×’×œ×‘×•×¢', presenter: '× ×™×‘ ×’×œ×‘×•×¢', role: '18:00', color: '#6366f1', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%A0%D7%99%D7%91_%D7%92%D7%9C%D7%91%D7%95%D7%A2.png', id: 'gilboa' },
            { name: '××”×“×•×¨×ª ×—××©', presenter: '×©×¨×•×Ÿ × ×™×¡×™×', role: '17:00', color: '#8b5cf6', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%A9%D7%A8%D7%95%D7%9F_%D7%A0%D7%99%D7%A1%D7%99%D7%9D.png', id: 'five' },
            { name: '×”×¢×¨×‘×™×¡×˜×™×', presenter: '×¦×‘×™ ×™×—×–×§××œ×™', role: '×—××™×©×™ ×•×©×‘×ª', color: '#ec4899', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%A6%D7%91%D7%99%D7%A7%D7%94_%D7%99%D7%97%D7%96%D7%A7%D7%9C%D7%99.png', id: 'arab' },
            { name: '×”×™×©×¨××œ×™×', presenter: '××•×¨×™ ×§×•××œ', role: '××—×¨×™ ×”××¨×›×–×™×ª', color: '#3b82f6', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%90%D7%95%D7%A8%D7%99_%D7%A7%D7%95%D7%95%D7%90%D7%9C.png', id: 'isra' },
            { name: '××“×‘×¨×™× ×—×“×©×•×ª', presenter: '××œ×™×¨×– ×©×“×”', role: '23:00', color: '#06b6d4', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%90%D7%9C%D7%99%D7%A8%D7%96_%D7%A9%D7%93%D7%94.png', id: 'talk' },
            { name: '××”×“×•×¨×ª ×¦×”×¨×™×™×', presenter: '×“× ×™××œ ×¨×•×˜-××‘× ×¨×™', role: '12:00', color: '#10b981', img: 'https://raw.githubusercontent.com/orengamchi/i24_gui_v2/main/%D7%93%D7%A0%D7%99%D7%90%D7%9C_%D7%A8%D7%95%D7%98_%D7%92%D7%93%D7%95%D7%9C.png', id: 'noon' },
            { name: '×—×“×¨ ×”×—×“×©×•×ª', presenter: '×¦×•×•×ª ×”×›×ª×‘×™×', role: '×›×œ ×©×¢×”', color: '#f43f5e', img: 'https://placehold.co/400x400/374151/f1f5f9?text=NEWS', id: 'news' }
        ];

        const TEMPLATES = [
            { name: '×ª×‘× ×™×ª ×¡×˜×•×¨×™', id: 'Story', icon: '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="7" y="2" width="10" height="20" rx="2" ry="2"></rect><line x1="12" y1="18" x2="12" y2="18.01"></line></svg>', color: 'border-orange-500' },
            { name: '×ª×‘× ×™×ª ××¦×’×ª', id: 'Presentation', icon: '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect><line x1="8" y1="21" x2="16" y2="21"></line><line x1="12" y1="17" x2="12" y2="21"></line></svg>', color: 'border-blue-500' },
            { name: '×ª×‘× ×™×ª ×××¡×˜×¨', id: 'Master', icon: '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><polygon points="12 2 2 7 12 12 22 7 12 2"></polygon><polyline points="2 17 12 22 22 17"></polyline><polyline points="2 12 12 17 22 12"></polyline></svg>', color: 'border-red-500' },
            { name: '×ª×‘× ×™×ª ×ª××œ×•×œ', id: 'Transcript', icon: '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>', color: 'border-green-500' },
            { name: '×ª×‘× ×™×ª ×¡×•×©×™××œ', id: 'SocialMedia', icon: '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>', color: 'border-purple-500' },
            { name: '×ª×‘× ×™×ª ×¢×™×ª×•×Ÿ', id: 'Newspaper', icon: '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"></path><path d="M18 14h-8"></path><path d="M15 18h-5"></path><path d="M10 6h8v4h-8V6Z"></path></svg>', color: 'border-yellow-500' },
            { name: '×ª×‘× ×™×ª ×‘×•×œ×˜×™×', id: 'Bullets', icon: '<svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>', color: 'border-teal-500' }
        ];

        const TEMPLATE_CONFIGS = {
            'Bullets': {
                title: '×˜×•×¤×¡ ×”×–×× ×” - ×‘×•×œ×˜×™×',
                fields: [
                    { id: 'main-title', label: '×›×•×ª×¨×ª ×¨××©×™×ª', lines: 2, maxLen: 15, isBold: true, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'subtitle', label: '×›×•×ª×¨×ª ××©× ×”', lines: 1, maxLen: 15, isBold: false, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' }, 
                    { id: 'section1', label: '×¡×¢×™×£ 1', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'section2', label: '×¡×¢×™×£ 2', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'section3', label: '×¡×¢×™×£ 3', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'section4', label: '×¡×¢×™×£ 4', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'section5', label: '×¡×¢×™×£ 5', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'section6', label: '×¡×¢×™×£ 6', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'section7', label: '×¡×¢×™×£ 7', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                    { id: 'section8', label: '×¡×¢×™×£ 8', lines: 2, maxLen: 30, defaultValue: '[×”×§×œ×“ ×›××Ÿ]' },
                ]
            }
        };

        let currentShow = null;
        let activeConfig = TEMPLATE_CONFIGS['Bullets'];

        document.addEventListener('DOMContentLoaded', () => {
            renderMenu();
            renderLobby();
            updateTime();
            setInterval(updateTime, 1000);
            updateBanner(DEFAULT_VIDEO, '××¢×¨×›×ª ×©×™×’×•×¨ ×’×¨×¤×™×§×”', 'i24NEWS Production');
            
            const dropzone = document.getElementById('main-image-dropzone');
            if(dropzone) {
                dropzone.addEventListener('click', () => document.getElementById('main-image-input').click());
                dropzone.addEventListener('dragover', (e) => { e.preventDefault(); dropzone.classList.add('border-blue-500', 'bg-slate-700'); });
                dropzone.addEventListener('dragleave', (e) => { e.preventDefault(); dropzone.classList.remove('border-blue-500', 'bg-slate-700'); });
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('border-blue-500', 'bg-slate-700');
                    if (e.dataTransfer.files.length) handleImageUpload({ files: e.dataTransfer.files });
                });
            }
        });

        function toggleMenu(e) {
            e.stopPropagation();
            document.getElementById('main-dropdown').classList.toggle('show');
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('#shortcut-strip')) {
                document.getElementById('main-dropdown').classList.remove('show');
            }
        });

        function renderMenu() {
            const menu = document.getElementById('main-dropdown');
            menu.innerHTML = SHOWS.map(show => `
                <div class="dropdown-item" 
                     onclick="selectShow('${show.id}'); document.getElementById('main-dropdown').classList.remove('show')"
                     onmouseover="this.style.borderRightColor='${show.color}'"
                     onmouseout="this.style.borderRightColor='transparent'">
                    ${show.name}
                </div>
            `).join('');
        }

        function renderLobby() {
            const grid = document.getElementById('presenters-grid');
            grid.innerHTML = SHOWS.map(show => `
                <div onclick="selectShow('${show.id}')" class="presenter-card bg-[#1e293b] rounded-xl overflow-hidden cursor-pointer shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:-translate-y-2 border-b-4" style="border-color: ${show.color}">
                    <div class="card-image-wrapper relative">
                        <div class="card-image" style="background-image: url('${show.img}')"></div>
                    </div>
                    <div class="p-4 relative z-10" style="background: inherit;">
                        <h3 class="text-xl font-bold text-white">${show.name}</h3>
                        <p class="text-gray-400 text-sm">${show.presenter}</p>
                    </div>
                </div>
            `).join('');
        }

        function selectShow(showId) {
            currentShow = SHOWS.find(s => s.id === showId);
            document.getElementById('lobby-view').classList.add('hidden');
            document.getElementById('bullets-form-view').classList.add('hidden');
            document.getElementById('template-lobby-view').classList.remove('hidden');
            updateBanner(TEMPLATE_VIDEO, '×‘×—×¨ ×ª×‘× ×™×ª ×’×¨×¤×™×ª', `×¢×‘×•×¨: ${currentShow.name}`);
            renderTemplates();
        }

        function showLobby() {
            document.getElementById('template-lobby-view').classList.add('hidden');
            document.getElementById('bullets-form-view').classList.add('hidden');
            document.getElementById('lobby-view').classList.remove('hidden');
            updateBanner(DEFAULT_VIDEO, '××¢×¨×›×ª ×©×™×’×•×¨ ×’×¨×¤×™×§×”', 'i24NEWS Production');
        }

        function renderTemplates() {
            const grid = document.getElementById('templates-grid');
            grid.innerHTML = TEMPLATES.map(t => {
                const isDisabled = t.id !== 'Bullets';
                const disabledClass = isDisabled ? 'disabled-card' : '';
                const geoIconClass = "geo-icon w-10 h-10 mx-auto mb-2"; 
                
                return `
                <div onclick="${isDisabled ? '' : `openTemplate('${t.id}')`}" 
                     class="template-card bg-[#1e293b] rounded-xl p-4 cursor-pointer shadow-md hover:bg-[#334155] border-b-4 ${t.color} transition text-center ${disabledClass}">
                    <div class="template-image-wrapper">
                        <div class="${geoIconClass}">${t.icon}</div>
                    </div>
                    <h3 class="text-white font-bold mt-2">${t.name}</h3>
                    ${isDisabled ? '<p class="text-xs text-yellow-400 mt-1">×‘×‘× ×™×™×”</p>' : ''}
                </div>
            `}).join('');
        }

        function showTemplateLobby() {
            document.getElementById('bullets-form-view').classList.add('hidden');
            document.getElementById('template-lobby-view').classList.remove('hidden');
            if(currentShow) {
                updateBanner(TEMPLATE_VIDEO, '×‘×—×¨ ×ª×‘× ×™×ª ×’×¨×¤×™×ª', `×¢×‘×•×¨: ${currentShow.name}`);
            }
        }

        function openTemplate(type) {
            if (type === 'Bullets') {
                activeConfig = TEMPLATE_CONFIGS['Bullets'];
                document.getElementById('template-lobby-view').classList.add('hidden');
                document.getElementById('bullets-form-view').classList.remove('hidden');
                
                document.getElementById('edition-name').value = currentShow.name;
                const formCard = document.getElementById('form-card');
                formCard.style.borderTopColor = currentShow.color;
                
                document.querySelectorAll('.form-section-title').forEach(el => {
                    el.style.color = currentShow.color;
                    el.style.borderColor = currentShow.color;
                });
                
                document.getElementById('main-form-title').innerText = `${activeConfig.title} | ${currentShow.name}`;
                updateBanner(DEFAULT_VIDEO, `${activeConfig.title}`, `××™×œ×•×™ ×¢×‘×•×¨: ${currentShow.name}`);
                
                // Clear Image path
                document.getElementById('main-image-path').value = '';
                document.getElementById('main-image-preview').style.display = 'none';

                renderDynamicContent();
            } 
        }

        function renderDynamicContent() {
            const container = document.getElementById('dynamic-content-section');
            if (!activeConfig) return;

            container.style.borderColor = currentShow ? currentShow.color : '#475569';

            let html = `<h3 class="text-lg font-bold mb-4 border-b pb-2 form-section-title" style="color:${currentShow.color}; border-color:${currentShow.color}">×ª×•×›×Ÿ ×”×’×¨×¤×™×§×” (× × ×œ××œ× ×‘××“×•×™×§)</h3>`;
            
            let bulletIndex = 0;

            activeConfig.fields.forEach(field => {
                const sectionId = field.id;
                const labelText = `${field.label} (××§×¡×™××•× ${field.maxLen} ×ª×•×•×™×):`;
                
                let isHidden = false;
                if (sectionId.startsWith('section')) {
                    bulletIndex++;
                    if (bulletIndex > 3) isHidden = true;
                }
                const visibilityClass = isHidden ? 'hidden hidden-bullet-row' : '';

                let widthClass = 'w-full';
                if (field.maxLen <= 15) {
                    widthClass = 'max-w-sm'; 
                } else if (field.maxLen <= 30) {
                     widthClass = 'max-w-lg'; 
                }

                html += `
                <div id="${sectionId}-section" class="mb-6 p-3 rounded hover:bg-white/5 transition border border-transparent hover:border-gray-600 ${visibilityClass}">
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-sm font-medium text-gray-300">${labelText}</label>
                        <button type="button" onclick="clearSection('${sectionId}')" class="bg-red-500 hover:bg-red-600 text-white text-xs px-2 py-1 rounded transition">ğŸ—‘ï¸ ×‘×˜×œ</button>
                    </div>`;

                if (field.isTextArea) {
                    html += `<textarea id="${sectionId}" class="input-style ${widthClass}" rows="${field.lines}" maxlength="${field.maxLen}" placeholder="${field.defaultValue}">${field.defaultValue || ''}</textarea>`;
                } else {
                    for (let i = 1; i <= field.lines; i++) {
                        const extraClasses = field.isBold ? 'font-bold text-lg' : '';
                        const ph = i > 1 ? `×©×•×¨×” ${i}` : field.defaultValue;
                        
                        html += `
                        <div class="mb-2">
                            <input type="text" id="${sectionId}-line${i}" 
                                   class="input-style ${extraClasses} ${widthClass}" 
                                   placeholder="${ph}" 
                                   value="${field.defaultValue && i===1 ? field.defaultValue : ''}" 
                                   maxlength="${field.maxLen}">
                        </div>`;
                    }
                }
                html += `</div>`;
            });

            html += `
            <div class="flex justify-center mt-4" id="add-bullet-container">
                <button type="button" onclick="showNextBullet()" class="flex items-center text-blue-400 hover:text-white border border-blue-400 hover:bg-blue-600 font-bold py-2 px-6 rounded-full transition-all text-sm">
                    <i class="fa-solid fa-plus ml-2"></i> ×”×•×¡×£ ×©×•×¨×” × ×•×¡×¤×ª
                </button>
            </div>
            `;
            
            html += `
            <div class="mt-8 p-4 border-t border-gray-700">
                <label class="block text-xs text-gray-500 mb-1 text-center font-bold">×˜×§×¡×˜ ×“×™×¡×§×œ×™×™××¨ (× ×™×ª×Ÿ ×œ×¢×¨×™×›×”):</label>
                <textarea id="disclaimer-text" class="w-full bg-transparent text-xs text-gray-400 text-center border-none focus:ring-0 resize-none overflow-hidden" rows="2">* ×”×˜×•×¤×¡ ××™×•×¢×“ ×œ×©×™××•×© ×¤× ×™××™ ×‘×œ×‘×“. ×× × ×•×“××• ×›×™ ×›×œ ×”×¤×¨×˜×™× × ×›×•× ×™× ×œ×¤× ×™ ×”×©×œ×™×—×”.</textarea>
            </div>`;

            container.innerHTML = html;
            
            setupEnterKeyNavigation();
            checkAddButtonVisibility();
        }
        
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('main-image-preview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                }
                reader.readAsDataURL(input.files[0]);
                document.getElementById('main-image-path').value = input.files[0].name; // Save filename as path
            }
        }

        window.showNextBullet = function() {
            const nextRow = document.querySelector('.hidden-bullet-row');
            if (nextRow) {
                nextRow.classList.remove('hidden');
                nextRow.classList.remove('hidden-bullet-row');
            }
            checkAddButtonVisibility();
        };

        function checkAddButtonVisibility() {
            const remaining = document.querySelectorAll('.hidden-bullet-row').length;
            const btnContainer = document.getElementById('add-bullet-container');
            if (remaining === 0 && btnContainer) {
                btnContainer.style.display = 'none';
            }
        }

        function clearSection(sectionId) {
            const section = document.getElementById(sectionId + '-section');
            if(!section) return;
            const isCancelled = section.classList.toggle('cancelled');
            section.querySelectorAll('input, textarea').forEach(input => {
                if(isCancelled) {
                    input.setAttribute('disabled', 'true');
                    input.dataset.oldValue = input.value;
                    input.value = "××‘×•×˜×œ";
                } else {
                    input.removeAttribute('disabled');
                    input.value = input.dataset.oldValue || "";
                }
            });
        }

        function setupEnterKeyNavigation() {
            const inputs = document.querySelectorAll('#orderForm input:not([disabled]), #orderForm textarea:not([disabled])');
            inputs.forEach((input, index) => {
                input.addEventListener('keydown', (e) => {
                    if(e.key === 'Enter' && input.tagName !== 'TEXTAREA') {
                        e.preventDefault();
                        if(inputs[index + 1]) inputs[index + 1].focus();
                    }
                });
            });
        }

        function updateBanner(videoUrl, title, subtitle) {
            const videoElement = document.getElementById('banner-video');
            const sourceElement = document.getElementById('banner-video-source');
            
            if (videoElement && sourceElement && videoUrl && sourceElement.src !== videoUrl) {
                sourceElement.src = videoUrl;
                videoElement.load();
                videoElement.play().catch(e => console.log("Autoplay prevented", e));
            }
            
            if (title === '××¢×¨×›×ª ×©×™×’×•×¨ ×’×¨×¤×™×§×”') {
                 document.getElementById('banner-title').textContent = '';
                 document.getElementById('banner-subtitle').textContent = '';
            } else {
                 document.getElementById('banner-title').textContent = title;
                 document.getElementById('banner-subtitle').textContent = subtitle;
            }
        }

        function updateTime() {
            const now = new Date();
            const dateInput = document.getElementById('broadcast-date');
            const timeInput = document.getElementById('estimated-time');

            if (dateInput && !dateInput.value) {
                dateInput.valueAsDate = now;
            }
            if (timeInput && !timeInput.value) {
                const timeString = now.toLocaleTimeString('he-IL', {hour:'2-digit', minute:'2-digit', hour12: false});
                timeInput.value = timeString;
            }
        }

        function toggleDarkMode() { return; }

        function openEditorWithParams() {
            const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : '';

            const senderName = getVal('sender-name');
            const editionName = getVal('edition-name');
            const broadcastDate = getVal('broadcast-date');
            const estimatedTime = getVal('estimated-time');
            const mainTitle = getVal('main-title-line1');
            const subTitle = getVal('subtitle-line1');
            const glassWall = document.getElementById('glass-wall-mode')?.checked ? 'true' : 'false';
            
            const fontSize = getVal('title-font-size');
            const shape = getVal('bullet-shape');
            const anim = getVal('bullet-animation');
            const disclaimer = getVal('disclaimer-text');
            const mainImage = getVal('main-image-path'); 
            const bgImage = getVal('bg-image-link');
            
            let items = [];
            for(let i = 1; i <= 8; i++) {
                const el = document.getElementById(`section${i}-line1`);
                if(el && el.value && el.value !== '[×”×§×œ×“ ×›××Ÿ]') {
                    items.push(el.value);
                }
            }
            
            // ×©×™× ×•×™ ×”×§×™×©×•×¨ ×œ×¢×•×¨×š ×œ-raw.githack.com
            const editorBaseUrl = 'https://raw.githack.com/orengamchi/i24_demo_app/refs/heads/main/after_coder_v36_clean_demo.html';
            
            const params = new URLSearchParams();
            if(senderName) params.append('sender', senderName);
            if(editionName) params.append('edition', editionName);
            if(broadcastDate) params.append('date', broadcastDate);
            if(estimatedTime) params.append('time', estimatedTime);
            
            if(mainTitle && mainTitle !== '[×”×§×œ×“ ×›××Ÿ]') params.append('title', mainTitle);
            if(subTitle && subTitle !== '[×”×§×œ×“ ×›××Ÿ]') params.append('subtitle', subTitle);
            
            if(items.length > 0) params.append('items', items.join('|'));
            if(mainImage) params.append('image', mainImage);
            if(bgImage) params.append('bg', bgImage);
            
            params.append('glass', glassWall);
            params.append('fontsize', fontSize);
            params.append('shape', shape);
            params.append('anim', anim);
            if(disclaimer) params.append('disclaimer', disclaimer);

            const fullUrl = `${editorBaseUrl}?${params.toString()}`;
            
            const newWindow = window.open(fullUrl, '_blank');
            if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') { 
                alert("×—×œ×•×Ÿ ×§×•×¤×¥ × ×—×¡×! ×× × ××¤×©×¨ ×—×œ×•× ×•×ª ×§×•×¤×¦×™× ×¢×‘×•×¨ ××ª×¨ ×–×” ×›×“×™ ×œ×¤×ª×•×— ××ª ×”×¢×•×¨×š.");
            }
        }

        function saveFormAsText() {
            const getVal = (id) => document.getElementById(id) ? document.getElementById(id).value : '';
            
            const sender = getVal('sender-name');
            const edition = getVal('edition-name');
            const date = getVal('broadcast-date');
            const time = getVal('estimated-time');
            
            const dateObj = new Date(date);
            const formattedDate = date ? dateObj.toLocaleDateString('he-IL') : '';

            const glassMode = document.getElementById('glass-wall-mode')?.checked ? '×›×Ÿ' : '×œ×';
            const fontSize = getVal('title-font-size');
            
            const shapeEl = document.getElementById('bullet-shape');
            const shape = shapeEl ? shapeEl.options[shapeEl.selectedIndex].text : '';
            
            const animEl = document.getElementById('bullet-animation');
            const anim = animEl ? animEl.options[animEl.selectedIndex].text : '';

            const disclaimer = getVal('disclaimer-text');
            const notes = getVal('notes');

            // Format filename: edition_date
            const safeEdition = (edition || 'unknown').replace(/\s/g, '_');
            const dateForFile = dateObj.toLocaleDateString('en-GB').replace(/\//g, '-'); 
            const filename = `${safeEdition}_${dateForFile}.txt`;

            let content = `× ×•×©×: ${activeConfig.title} (××”×“×•×¨×ª ${formattedDate})
----------------------------------------
×¤×¨×˜×™ ×”×–×× ×”:
×©× ×”×©×•×œ×—/×›×ª×‘: ${sender || '[×œ× ××•×œ×]'}
×©× ×”××”×“×•×¨×”: ${edition || '[×œ× ××•×œ×]'}
×ª××¨×™×š ×©×™×“×•×¨: ${formattedDate}
×©×¢×ª ×©×™×“×•×¨ ××©×•×¢×¨×ª: ${time}
----------------------------------------
××¦×‘ ×§×™×¨ ×–×›×•×›×™×ª: ${glassMode}
×’×•×“×œ ×¤×•× ×˜ ×›×•×ª×¨×ª: ${fontSize}
----------------------------------------
×¦×•×¨×ª ×‘×•×œ×˜×™× (××—×§ ××ª ×”××™×•×ª×¨):
${shape}
----------------------------------------
×× ×™××¦×™×™×ª ×‘×•×œ×˜×™× (××—×§ ××ª ×”××™×•×ª×¨):
${anim}
----------------------------------------
×§×‘×¦×™× ××¦×•×¨×¤×™× (×¡××Ÿ ×‘-X ×× ×¨×œ×•×•× ×˜×™):
`;
            const files = Array.from(document.querySelectorAll('.attachment-checkbox')).map(cb => {
                const label = cb.dataset.label;
                const mark = cb.checked ? '[X]' : '[ ]';
                if(label.includes('××•×“×™×•')) return `${mark} ×§×•×‘×¥ ××•×“×™×• (×§×¨×™×™× ×•×ª ×œ×’×¨×¤×™×§×”)`;
                if(label.includes('×ª××•× ×”')) return `${mark} ×ª××•× ×” (×¨×§×¢ ××• ××™×œ×•×¡×˜×¨×¦×™×”)`;
                if(label.includes('×•×™×“××•')) return `${mark} ×§×•×‘×¥ ×•×™×“××•`;
                return `${mark} ${label}`;
            }).join('\n');
            content += files + '\n\n';

            const mainLink = getVal('main-image-path'); 
            const bgLink = getVal('bg-image-link');
            content += `×§×™×©×•×¨ ×ª××•× ×” ×¨××©×™×ª: ${mainLink} \n`;
            content += `×§×™×©×•×¨ ×ª××•× ×ª ×¨×§×¢: ${bgLink} \n`;
            
            content += `----------------------------------------\n`;
            content += `×ª×•×›×Ÿ ×”×’×¨×¤×™×§×” (× × ×œ××œ× ×‘××“×•×™×§):\n\n`;
            
            activeConfig.fields.forEach(f => {
                const sec = document.getElementById(f.id + '-section');
                if (!sec || sec.classList.contains('hidden')) return; 

                content += `${f.label}:\n`;
                if(sec.classList.contains('cancelled')) {
                    content += `[××‘×•×˜×œ]\n\n`;
                } else {
                    if(f.isTextArea) {
                        content += getVal(f.id) + '\n\n';
                    } else {
                        for(let i=1; i<=f.lines; i++) {
                            const val = getVal(`${f.id}-line${i}`);
                            content += val + '\n';
                        }
                        content += '\n';
                    }
                }
            });
            
            content += `----------------------------------------\n`;
            content += `×”×¢×¨×•×ª × ×•×¡×¤×•×ª ×œ×’×¨×¤×™×§××™ (×¦×‘×¢×™×/×¡×’× ×•×Ÿ/×“×’×©×™×):\n`;
            content += `${notes || '[×”×§×œ×“ ×›××Ÿ]'}\n\n`;
            
            if (disclaimer) {
                 content += `----------------------------------------\n`;
                 content += `×“×™×¡×§×œ×™×™××¨:\n${disclaimer}\n`;
            }

            const blob = new Blob([content], {type: 'text/plain;charset=utf-8'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            logRequest('Bullets', 'internal', '×¤× ×™××™');
        }

        window.logRequest = function(type, url, status) {
            if(window.app && window.app.logToFirebase) {
                window.app.logToFirebase(type, url, status);
            }
        };
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);

            window.app = window.app || {};
            
            window.app.logToFirebase = async (type, url, status) => {
                if (!auth.currentUser) return;
                try {
                    await addDoc(collection(db, `/artifacts/${appId}/public/data/graphics_requests_log`), {
                        show: document.getElementById('edition-name').value || '×›×œ×œ×™',
                        templateType: type,
                        reporterId: auth.currentUser.uid,
                        externalUrl: url,
                        timestamp: serverTimestamp(),
                        status: status
                    });
                } catch (e) { console.error("Log failed", e); }
            };

            const initAuth = async () => {
                try {
                    if (initialAuthToken) await signInWithCustomToken(auth, initialAuthToken);
                    else await signInAnonymously(auth);
                } catch (e) { console.error("Auth failed", e); }
            };

            initAuth(); 
        }
    </script>
</body>
</html>